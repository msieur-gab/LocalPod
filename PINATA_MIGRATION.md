# Pinata Migration Plan: Sovereign IPFS Storage

**Branch:** `feat/pinata-sovereign-storage`
**Date:** 2025-10-24
**Status:** üü° Planning

---

## Why This Migration?

### Problem with Current Architecture
- Uses Filebase S3 with presigned URLs generated by grant.html
- Requires AWS secret keys to be embedded somewhere (security risk)
- Users don't control their own IPFS pinning
- Contradicts the European tech independence vision

### Solution: User-Controlled Pinata
- Each user brings their own Pinata API key (JWT)
- True data sovereignty: users control their own IPFS pinning
- Portable CIDs: work on any IPFS gateway
- Simpler architecture: no AWS signature complexity
- European-friendly: users can choose providers

---

## Architecture Changes

### Before (S3 Presigned URLs)
```
User ‚Üí demo.html ‚Üí grant.html (generates presigned URL using AWS keys)
                 ‚Üì
            simple-service.html (uses presigned URL for 1 hour)
                 ‚Üì
            Filebase S3 ‚Üí IPFS
```

### After (Pinata JWT)
```
User ‚Üí demo.html (stores Pinata JWT)
     ‚Üì
     grant.html (passes JWT via UCAN)
     ‚Üì
     simple-service.html (uses JWT with Pinata API directly)
     ‚Üì
     Pinata ‚Üí IPFS
```

---

## Files to Modify

### 1. `sdk/storage.js` or `sdk/index.js`
**Current State:** Contains S3/AWS Signature V4 code for Filebase
**Changes Needed:**
- [ ] Remove `generatePresignedUploadUrl()` method
- [ ] Remove `generatePresignedDownloadUrl()` method
- [ ] Remove all AWS signature helper functions (hmac, sha256Hex, etc.)
- [ ] Add `uploadToPinata(jsonData, pinataJwt)` method
- [ ] Add `loadFromPinata(cid, pinataGateway)` method
- [ ] Keep UCAN generation/validation intact

**New Pinata Methods:**
```javascript
async uploadToPinata(jsonData, pinataJwt) {
  // Convert JSON to File object
  // POST to https://uploads.pinata.cloud/v3/files
  // Return CID from response
}

async loadFromPinata(cid, pinataGateway = 'gateway.pinata.cloud') {
  // GET from https://{gateway}/ipfs/{cid}
  // Return parsed JSON
}
```

---

### 2. `demo.html` (Pod Manager)
**Current State:** Manages identity, stores S3 credentials (if any)
**Changes Needed:**
- [ ] Add Pinata configuration section to UI
- [ ] Input field for Pinata JWT (API key)
- [ ] Optional: custom Pinata gateway URL
- [ ] Store Pinata JWT encrypted in IndexedDB (alongside identity)
- [ ] Remove any S3/Filebase credential management
- [ ] Add "Get Pinata API Key" link/instructions

**UI Addition:**
```html
<section>
  <h3>üîë IPFS Storage Configuration</h3>
  <label>Pinata JWT Token:</label>
  <input type="password" id="pinata-jwt" />
  <button id="save-pinata-config">Save</button>
  <p class="help">
    Get your free Pinata API key at
    <a href="https://app.pinata.cloud" target="_blank">app.pinata.cloud</a>
  </p>
</section>
```

**Storage Schema Update:**
```javascript
// Add to IndexedDB encryption
{
  identity: { ... },
  storage: {
    provider: 'pinata',
    pinataJwt: 'encrypted_jwt_here',
    pinataGateway: 'gateway.pinata.cloud'
  }
}
```

---

### 3. `grant.html` (Authorization Flow)
**Current State:** Generates presigned URLs using S3 credentials
**Changes Needed:**
- [ ] Remove `generatePresignedUploadUrl()` call
- [ ] Remove `generatePresignedDownloadUrl()` call
- [ ] Retrieve Pinata JWT from IndexedDB (user's pod storage config)
- [ ] Pass Pinata JWT in grant payload instead of presigned URLs
- [ ] Update UCAN to include `storage_provider: 'pinata'` in facts

**Grant Payload Before:**
```javascript
{
  grantApproved: true,
  ucan: ucanToken,
  presignedUploadUrl: { url: '...', method: 'PUT', ... },
  presignedDownloadUrl: { url: '...', method: 'GET', ... },
  userPublicKey: '...',
  ...
}
```

**Grant Payload After:**
```javascript
{
  grantApproved: true,
  ucan: ucanToken,
  pinataJwt: 'user_pinata_jwt_here',
  pinataGateway: 'gateway.pinata.cloud',
  userPublicKey: '...',
  storageProvider: 'pinata',
  ...
}
```

---

### 4. `simple-service.html` (Example Service)
**Current State:** Uses presigned URLs for upload/download
**Changes Needed:**
- [ ] Remove presigned URL state management
- [ ] Remove presigned URL renewal logic
- [ ] Add Pinata JWT to state
- [ ] Update `saveItem()` to use Pinata API directly
- [ ] Update `loadData()` to use Pinata gateway
- [ ] Remove dependency on `renew-presigned-url.html`

**State Before:**
```javascript
let state = {
  ucanToken: null,
  presignedUploadUrl: null,
  presignedDownloadUrl: null,
  userPublicKey: null,
  ipfsCid: null,
  items: []
};
```

**State After:**
```javascript
let state = {
  ucanToken: null,
  pinataJwt: null,
  pinataGateway: 'gateway.pinata.cloud',
  userPublicKey: null,
  ipfsCid: null,
  items: []
};
```

**Upload Logic:**
```javascript
async function saveItem() {
  // ... prepare data ...

  // Upload to Pinata
  const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
  const file = new File([blob], 'data.json');

  const formData = new FormData();
  formData.append('file', file);

  const response = await fetch('https://uploads.pinata.cloud/v3/files', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${state.pinataJwt}`
    },
    body: formData
  });

  const result = await response.json();
  state.ipfsCid = result.data.cid;

  // Save CID to localStorage
  // ...
}
```

**Download Logic:**
```javascript
async function loadData() {
  if (!state.ipfsCid) {
    state.items = [];
    return;
  }

  const gatewayUrl = `https://${state.pinataGateway}/ipfs/${state.ipfsCid}`;
  const response = await fetch(gatewayUrl);
  const data = await response.json();
  state.items = data.items || [];
}
```

---

### 5. `renew-presigned-url.html` (Optional)
**Status:** Can be deleted entirely
**Reason:** Pinata JWT doesn't expire hourly like presigned URLs

---

## Implementation Order

1. ‚úÖ Create branch `feat/pinata-sovereign-storage`
2. üîÑ Write this migration plan
3. ‚è≥ Update SDK (storage.js) - Add Pinata methods
4. ‚è≥ Update demo.html - Add Pinata config UI
5. ‚è≥ Update grant.html - Pass JWT instead of presigned URLs
6. ‚è≥ Update simple-service.html - Use Pinata API
7. ‚è≥ Test end-to-end flow
8. ‚è≥ Clean up: Remove unused files (renew-presigned-url.html, netlify/functions/*)
9. ‚è≥ Update README with Pinata setup instructions
10. ‚è≥ Commit and create PR

---

## Testing Checklist

### Setup
- [ ] User signs up for free Pinata account at https://app.pinata.cloud
- [ ] User creates API key with upload permissions
- [ ] User configures JWT in demo.html

### Flow Testing
- [ ] Open demo.html, configure Pinata JWT, verify it saves
- [ ] Open simple-service.html, click "Connect with LocalPod"
- [ ] Grant.html receives Pinata JWT from pod
- [ ] Create a post in simple-service.html
- [ ] Verify upload to Pinata succeeds, CID returned
- [ ] Refresh page, verify post loads from IPFS via Pinata gateway
- [ ] Clear localStorage, verify CID recovery still works (or graceful empty state)

### Edge Cases
- [ ] No Pinata JWT configured - should show error message
- [ ] Invalid Pinata JWT - should show authentication error
- [ ] Network error during upload - should show retry option
- [ ] CID not found on gateway - should handle gracefully

---

## Migration Benefits Summary

### Security
‚úÖ No AWS secret keys in codebase
‚úÖ Each user controls their own credentials
‚úÖ JWT scoped to user's Pinata account

### Sovereignty
‚úÖ Users bring their own storage provider
‚úÖ Can switch providers (CIDs are portable)
‚úÖ European users can choose EU-based IPFS services

### Simplicity
‚úÖ Remove complex AWS Signature V4 code
‚úÖ No presigned URL expiration/renewal logic
‚úÖ Simple REST API calls

### Decentralization
‚úÖ Data stored on IPFS (content-addressed)
‚úÖ CIDs work on any IPFS gateway
‚úÖ Aligns with European tech independence vision

---

## Risks & Mitigations

### Risk 1: Users don't want to create Pinata accounts
**Mitigation:** Provide clear onboarding, explain sovereignty benefits

### Risk 2: Pinata free tier limits (1GB storage, 3GB bandwidth/month)
**Mitigation:** Document limits, allow users to upgrade or switch providers

### Risk 3: JWT exposure in browser
**Mitigation:** Store encrypted in IndexedDB, never log in console

### Risk 4: Pinata service outage
**Mitigation:** CIDs are portable, users can retrieve from other gateways

---

## Future Enhancements

- Support multiple IPFS providers (not just Pinata)
- Add provider abstraction layer in SDK
- Support IPFS Desktop node as provider option
- Add CID pinning verification UI
- Add storage usage dashboard

---

## Questions for User

1. Should we support multiple IPFS providers from the start, or focus on Pinata first?
2. Should Pinata JWT be optional (fallback to read-only IPFS gateway)?
3. Do you want a "demo mode" that works without any API keys for trying it out?

---

**Next Steps:** Review this plan, then proceed with SDK updates (step 3)
