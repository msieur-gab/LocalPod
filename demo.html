<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Identity Platform SDK - Demo</title>
  <link rel="stylesheet" href="./demo.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>üîê Identity Platform SDK</h1>
      <p>Demo Application - Account Management & Collaboration</p>
    </header>

    <!-- Authentication Gate -->
    <div id="auth-gate" class="section">
      <div class="card">
        <h2>Welcome</h2>
        <p id="auth-message">Loading...</p>

        <!-- Mode Switcher -->
        <div id="mode-switcher" class="mode-switcher" style="display: none;">
          <button id="show-login" class="mode-btn active">Login</button>
          <button id="show-signup" class="mode-btn">Create Account</button>
          <button id="show-import" class="mode-btn">Import Account</button>
        </div>

        <!-- Login Form -->
        <form id="login-form" style="display: none;">
          <div class="form-group">
            <label for="login-username">Username</label>
            <select id="login-username" required>
              <option value="">Select account...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="login-password">Password</label>
            <div class="password-input-wrapper">
              <input type="password" id="login-password" required placeholder="Enter your password">
              <button type="button" class="password-toggle" data-target="login-password" aria-label="Toggle password visibility">
                <svg class="password-toggle-icon eye-show" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9M12,4.5C17,4.5 21.27,7.61 23,12C21.27,16.39 17,19.5 12,19.5C7,19.5 2.73,16.39 1,12C2.73,7.61 7,4.5 12,4.5M3.18,12C4.83,15.36 8.24,17.5 12,17.5C15.76,17.5 19.17,15.36 20.82,12C19.17,8.64 15.76,6.5 12,6.5C8.24,6.5 4.83,8.64 3.18,12Z" /></svg>
                <svg class="password-toggle-icon eye-hide" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;"><path d="M2,5.27L3.28,4L20,20.72L18.73,22L15.65,18.92C14.5,19.3 13.28,19.5 12,19.5C7,19.5 2.73,16.39 1,12C1.69,10.24 2.79,8.69 4.19,7.46L2,5.27M12,9A3,3 0 0,1 15,12C15,12.35 14.94,12.69 14.83,13L11,9.17C11.31,9.06 11.65,9 12,9M12,4.5C17,4.5 21.27,7.61 23,12C22.18,14.08 20.79,15.88 19,17.19L17.58,15.76C18.94,14.82 20.06,13.54 20.82,12C19.17,8.64 15.76,6.5 12,6.5C10.91,6.5 9.84,6.68 8.84,7L7.3,5.47C8.74,4.85 10.33,4.5 12,4.5M3.18,12C4.83,15.36 8.24,17.5 12,17.5C12.69,17.5 13.37,17.43 14,17.29L11.72,15C10.29,14.85 9.15,13.71 9,12.28L5.6,8.87C4.61,9.72 3.78,10.78 3.18,12Z" /></svg>
              </button>
            </div>
          </div>
          <div id="login-error" class="error" style="display: none;"></div>
          <button type="submit" class="btn btn-primary">Unlock Account</button>
        </form>

        <!-- Signup Form -->
        <form id="signup-form" style="display: none;">
          <div class="form-group">
            <label for="signup-username">Username</label>
            <input type="text" id="signup-username" required placeholder="Choose a username" autocomplete="username">
          </div>
          <div class="form-group">
            <label for="signup-password">Password</label>
            <div class="password-input-wrapper">
              <input type="password" id="signup-password" required minlength="12" placeholder="Min 12 chars: uppercase, lowercase, number, special" autocomplete="new-password">
              <button type="button" class="password-toggle" data-target="signup-password" aria-label="Toggle password visibility">
                <svg class="password-toggle-icon eye-show" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9M12,4.5C17,4.5 21.27,7.61 23,12C21.27,16.39 17,19.5 12,19.5C7,19.5 2.73,16.39 1,12C2.73,7.61 7,4.5 12,4.5M3.18,12C4.83,15.36 8.24,17.5 12,17.5C15.76,17.5 19.17,15.36 20.82,12C19.17,8.64 15.76,6.5 12,6.5C8.24,6.5 4.83,8.64 3.18,12Z" /></svg>
                <svg class="password-toggle-icon eye-hide" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;"><path d="M2,5.27L3.28,4L20,20.72L18.73,22L15.65,18.92C14.5,19.3 13.28,19.5 12,19.5C7,19.5 2.73,16.39 1,12C1.69,10.24 2.79,8.69 4.19,7.46L2,5.27M12,9A3,3 0 0,1 15,12C15,12.35 14.94,12.69 14.83,13L11,9.17C11.31,9.06 11.65,9 12,9M12,4.5C17,4.5 21.27,7.61 23,12C22.18,14.08 20.79,15.88 19,17.19L17.58,15.76C18.94,14.82 20.06,13.54 20.82,12C19.17,8.64 15.76,6.5 12,6.5C10.91,6.5 9.84,6.68 8.84,7L7.3,5.47C8.74,4.85 10.33,4.5 12,4.5M3.18,12C4.83,15.36 8.24,17.5 12,17.5C12.69,17.5 13.37,17.43 14,17.29L11.72,15C10.29,14.85 9.15,13.71 9,12.28L5.6,8.87C4.61,9.72 3.78,10.78 3.18,12Z" /></svg>
              </button>
            </div>
            <small>Password must contain: uppercase, lowercase, number, special character</small>
          </div>
          <div class="form-group">
            <label for="signup-confirm">Confirm Password</label>
            <div class="password-input-wrapper">
              <input type="password" id="signup-confirm" required placeholder="Re-enter password" autocomplete="new-password">
              <button type="button" class="password-toggle" data-target="signup-confirm" aria-label="Toggle password visibility">
                <svg class="password-toggle-icon eye-show" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9M12,4.5C17,4.5 21.27,7.61 23,12C21.27,16.39 17,19.5 12,19.5C7,19.5 2.73,16.39 1,12C2.73,7.61 7,4.5 12,4.5M3.18,12C4.83,15.36 8.24,17.5 12,17.5C15.76,17.5 19.17,15.36 20.82,12C19.17,8.64 15.76,6.5 12,6.5C8.24,6.5 4.83,8.64 3.18,12Z" /></svg>
                <svg class="password-toggle-icon eye-hide" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;"><path d="M2,5.27L3.28,4L20,20.72L18.73,22L15.65,18.92C14.5,19.3 13.28,19.5 12,19.5C7,19.5 2.73,16.39 1,12C1.69,10.24 2.79,8.69 4.19,7.46L2,5.27M12,9A3,3 0 0,1 15,12C15,12.35 14.94,12.69 14.83,13L11,9.17C11.31,9.06 11.65,9 12,9M12,4.5C17,4.5 21.27,7.61 23,12C22.18,14.08 20.79,15.88 19,17.19L17.58,15.76C18.94,14.82 20.06,13.54 20.82,12C19.17,8.64 15.76,6.5 12,6.5C10.91,6.5 9.84,6.68 8.84,7L7.3,5.47C8.74,4.85 10.33,4.5 12,4.5M3.18,12C4.83,15.36 8.24,17.5 12,17.5C12.69,17.5 13.37,17.43 14,17.29L11.72,15C10.29,14.85 9.15,13.71 9,12.28L5.6,8.87C4.61,9.72 3.78,10.78 3.18,12Z" /></svg>
              </button>
            </div>
          </div>
          <div id="signup-error" class="error" style="display: none;"></div>
          <button type="submit" class="btn btn-primary">Create Account</button>
        </form>

        <!-- Import Account Form -->
        <form id="import-form" style="display: none;">
          <p class="info-text">
            üîÑ <strong>Recover your account</strong> from Pinata IPFS using your public key and password.
            Your encrypted backup will be fetched and decrypted.
          </p>
          <div class="form-group">
            <label for="import-publickey">Public Key</label>
            <textarea id="import-publickey" required placeholder="Paste your public key here..." rows="2"></textarea>
            <small>Get this from your identity card or QR code</small>
          </div>
          <div class="form-group">
            <label for="import-cid">Backup CID (Optional)</label>
            <input type="text" id="import-cid" placeholder="Qm... or bafy..." autocomplete="off">
            <small>If you recorded the backup CID, paste it here to recover without a Pinata API key.</small>
          </div>
          <div class="form-group">
            <label for="import-username">New Username (Local)</label>
            <input type="text" id="import-username" required placeholder="Username for this device" autocomplete="username">
            <small>This will be the username on this device</small>
          </div>
          <div class="form-group">
            <label for="import-password">Password</label>
            <div class="password-input-wrapper">
              <input type="password" id="import-password" required placeholder="Your account password" autocomplete="current-password">
              <button type="button" class="password-toggle" data-target="import-password" aria-label="Toggle password visibility">
                <svg class="password-toggle-icon eye-show" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9M12,4.5C17,4.5 21.27,7.61 23,12C21.27,16.39 17,19.5 12,19.5C7,19.5 2.73,16.39 1,12C2.73,7.61 7,4.5 12,4.5M3.18,12C4.83,15.36 8.24,17.5 12,17.5C15.76,17.5 19.17,15.36 20.82,12C19.17,8.64 15.76,6.5 12,6.5C8.24,6.5 4.83,8.64 3.18,12Z" /></svg>
                <svg class="password-toggle-icon eye-hide" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;"><path d="M2,5.27L3.28,4L20,20.72L18.73,22L15.65,18.92C14.5,19.3 13.28,19.5 12,19.5C7,19.5 2.73,16.39 1,12C1.69,10.24 2.79,8.69 4.19,7.46L2,5.27M12,9A3,3 0 0,1 15,12C15,12.35 14.94,12.69 14.83,13L11,9.17C11.31,9.06 11.65,9 12,9M12,4.5C17,4.5 21.27,7.61 23,12C22.18,14.08 20.79,15.88 19,17.19L17.58,15.76C18.94,14.82 20.06,13.54 20.82,12C19.17,8.64 15.76,6.5 12,6.5C10.91,6.5 9.84,6.68 8.84,7L7.3,5.47C8.74,4.85 10.33,4.5 12,4.5M3.18,12C4.83,15.36 8.24,17.5 12,17.5C12.69,17.5 13.37,17.43 14,17.29L11.72,15C10.29,14.85 9.15,13.71 9,12.28L5.6,8.87C4.61,9.72 3.78,10.78 3.18,12Z" /></svg>
              </button>
            </div>
            <small>Same password you used when creating the account</small>
          </div>
          <div id="import-error" class="error" style="display: none;"></div>
          <div id="import-status" class="info" style="display: none;"></div>
          <button type="submit" class="btn btn-primary">Import Account</button>
        </form>
      </div>
    </div>

    <!-- Main App (shown after authentication) -->
    <div id="main-app" style="display: none;">

      <!-- User Identity Card -->
      <div class="section">
        <div class="card">
          <h2>Your Identity</h2>

          <div class="identity-container">
            <!-- QR Code / Avatar Display -->
            <div class="qr-avatar-container">
              <div id="qr-code-display" class="qr-code-wrapper">
                <canvas id="qr-canvas"></canvas>
              </div>
              <div id="avatar-display" class="avatar-wrapper" style="display: none;">
                <img id="avatar-img" src="" alt="Avatar">
              </div>
              <button id="btn-edit-profile" class="btn btn-small btn-secondary">Edit Profile</button>
            </div>

            <!-- Identity Info -->
            <div id="identity-info" class="identity-info">
              <!-- Populated dynamically -->
            </div>
          </div>

          <div class="button-group">
            <button id="btn-logout" class="btn btn-secondary">Lock Account</button>
            <button id="btn-copy-recovery-key" class="btn btn-secondary">Copy Recovery Key</button>
            <button id="btn-copy-key" class="btn btn-secondary">Copy Collaboration Share</button>
            <button id="btn-register-passkey" class="btn btn-secondary">Register Passkey</button>
          </div>
        </div>
      </div>

      <!-- Edit Profile Dialog (hidden by default) -->
      <div id="profile-dialog" class="dialog-overlay" style="display: none;">
        <div class="dialog">
          <h2>Edit Profile</h2>
          <form id="profile-form">
            <div class="form-group">
              <label for="profile-displayname">Display Name</label>
              <input type="text" id="profile-displayname" placeholder="e.g., Alice Wonderland">
            </div>
            <div class="form-group">
              <label for="profile-bio">Bio</label>
              <textarea id="profile-bio" placeholder="Tell others about yourself..." rows="3" maxlength="280"></textarea>
              <small>Max 280 characters - visible to anyone who knows your public key</small>
            </div>
            <div class="form-group">
              <label for="profile-avatar">Avatar Image</label>
              <input type="file" id="profile-avatar" accept="image/*">
              <small>Upload a square image (will be converted to base64, max 500KB recommended)</small>
            </div>
            <div id="avatar-preview" class="avatar-preview" style="display: none;">
              <img id="avatar-preview-img" src="" alt="Avatar preview">
              <button type="button" id="btn-remove-avatar" class="btn btn-small btn-secondary">Remove Avatar</button>
            </div>
            <div class="button-group">
              <button type="submit" class="btn btn-primary">Save Profile</button>
              <button type="button" id="btn-cancel-profile" class="btn btn-secondary">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- IPFS Storage Configuration -->
      <div class="section">
        <div class="card">
          <h2>üîë IPFS Storage Configuration</h2>
          <p class="info-text">
            Configure your IPFS pinning provider for sovereign data storage.
            Your API key is encrypted and stored locally on this device.
          </p>

          <form id="storage-config-form">
            <div class="form-group">
              <label for="ipfs-provider">Provider</label>
              <select id="ipfs-provider" required>
                <option value="">Select provider...</option>
                <option value="pinata">Pinata</option>
                <option value="scaleway">Scaleway Labs (Coming Soon)</option>
                <option value="4everland">4everland (Coming Soon)</option>
              </select>
              <small id="provider-description">Choose your IPFS pinning service</small>
            </div>

            <div class="form-group">
              <label for="provider-jwt">API Key (JWT)</label>
              <div class="password-input-wrapper">
                <input type="password" id="provider-jwt" placeholder="Enter your provider API key">
                <button type="button" class="password-toggle" data-target="provider-jwt" aria-label="Toggle API key visibility">
                  <svg class="password-toggle-icon eye-show" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9M12,4.5C17,4.5 21.27,7.61 23,12C21.27,16.39 17,19.5 12,19.5C7,19.5 2.73,16.39 1,12C2.73,7.61 7,4.5 12,4.5M3.18,12C4.83,15.36 8.24,17.5 12,17.5C15.76,17.5 19.17,15.36 20.82,12C19.17,8.64 15.76,6.5 12,6.5C8.24,6.5 4.83,8.64 3.18,12Z" /></svg>
                  <svg class="password-toggle-icon eye-hide" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;"><path d="M2,5.27L3.28,4L20,20.72L18.73,22L15.65,18.92C14.5,19.3 13.28,19.5 12,19.5C7,19.5 2.73,16.39 1,12C1.69,10.24 2.79,8.69 4.19,7.46L2,5.27M12,9A3,3 0 0,1 15,12C15,12.35 14.94,12.69 14.83,13L11,9.17C11.31,9.06 11.65,9 12,9M12,4.5C17,4.5 21.27,7.61 23,12C22.18,14.08 20.79,15.88 19,17.19L17.58,15.76C18.94,14.82 20.06,13.54 20.82,12C19.17,8.64 15.76,6.5 12,6.5C10.91,6.5 9.84,6.68 8.84,7L7.3,5.47C8.74,4.85 10.33,4.5 12,4.5M3.18,12C4.83,15.36 8.24,17.5 12,17.5C12.69,17.5 13.37,17.43 14,17.29L11.72,15C10.29,14.85 9.15,13.71 9,12.28L5.6,8.87C4.61,9.72 3.78,10.78 3.18,12Z" /></svg>
                </button>
              </div>
              <small id="provider-help-text">Get your API key from your provider's dashboard</small>
            </div>

            <div class="form-group">
              <label for="provider-gateway">Custom Gateway Domain (Optional)</label>
              <input type="text" id="provider-gateway" placeholder="my-gateway.mypinata.cloud">
              <small>Use your dedicated Pinata gateway to avoid rate limits. Leave empty to use public IPFS gateways (dweb.link, ipfs.io, w3s.link)</small>
            </div>

            <div id="storage-config-status" class="info" style="display: none;"></div>
            <div id="storage-config-error" class="error" style="display: none;"></div>

            <div class="button-group">
              <button type="submit" class="btn btn-primary">Save Configuration</button>
              <button type="button" id="btn-clear-storage-config" class="btn btn-secondary">Clear Configuration</button>
            </div>
          </form>

          <!-- Provider Help Links -->
          <div id="provider-help-links" class="info-text" style="margin-top: 1rem; display: none;">
            <!-- Populated dynamically based on selected provider -->
          </div>
        </div>
      </div>

      <!-- Collaborators Section -->
      <div class="section">
        <div class="card">
          <div class="card-header">
            <h2>Collaborators</h2>
            <div class="button-group">
              <button id="btn-scan-collaborator" class="btn btn-primary">üì∑ Scan QR Code</button>
              <button id="btn-add-collaborator" class="btn btn-secondary">+ Add Manually</button>
            </div>
          </div>

          <!-- QR Scanner Component -->
          <collaborator-scanner id="collaborator-scanner"></collaborator-scanner>

          <div id="collaborators-list" class="collaborators-list">
            <!-- Populated dynamically -->
          </div>
        </div>
      </div>

      <!-- Add Collaborator Form (hidden by default) -->
      <div id="add-collaborator-section" class="section" style="display: none;">
        <div class="card">
          <h2>Add New Collaborator</h2>
          <p class="info-text" id="auto-discovery-info">
            üéâ <strong>Auto-Discovery:</strong> Share the JSON payload generated from an identity card
            (QR or copy) to add collaborators with both signing and encryption keys. The SDK will
            automatically fetch their profile (name, avatar, bio) from Pinata IPFS when available.
            <br><br>
            <strong>Status:</strong> Remote storage is <span id="remote-status" style="font-weight: 700;">checking...</span>
          </p>
          <form id="add-collaborator-form">
            <div class="form-group">
              <label for="collaborator-name">Display Name (Optional)</label>
              <input type="text" id="collaborator-name" placeholder="e.g., Alice (fallback if profile not found)">
              <small>Leave empty to use their remote profile name</small>
            </div>
            <div class="form-group">
              <label for="collaborator-key">Collaborator Share JSON</label>
              <textarea id="collaborator-key" required placeholder='{"publicKey":"...","encryptionPublicKey":"...","did":"did:key:..."}' rows="3"></textarea>
              <small>Paste the JSON payload from the collaborator's QR code or copy action.</small>
            </div>
            <div id="add-collaborator-status" class="info" style="display: none;"></div>
            <div id="add-collaborator-error" class="error" style="display: none;"></div>
            <div class="button-group">
              <button type="submit" class="btn btn-primary">Add Collaborator</button>
              <button type="button" id="btn-cancel-add" class="btn btn-secondary">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Statistics -->
      <div class="section">
        <div class="card">
          <h2>Platform Statistics</h2>
          <div id="stats-display" class="stats-grid">
            <!-- Populated dynamically -->
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast" style="display: none;"></div>
  </div>

  <!-- Import Maps for Dependencies -->
  <script type="importmap">
  {
    "imports": {
      "@localPod/identity-platform": "./sdk/index.js",
      "dexie": "https://cdn.jsdelivr.net/npm/dexie@3.2.3/+esm",
      "@noble/curves/ed25519": "https://esm.sh/@noble/curves@1.4.0/ed25519",
      "@scure/base": "https://cdn.jsdelivr.net/npm/@scure/base@1.1.1/+esm",
      "qrcode": "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm"
    }
  }
  </script>

  <!-- Import Collaborator Scanner Component -->
  <script type="module" src="./components/collaborator-scanner.js"></script>

  <script type="module" src="./demo.js"></script>
</body>
</html>
